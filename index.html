<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MatchGym ¬∑ PUCV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <style>
    :root {
      --bg: #050816;
      --bg-card: #0b1120;
      --accent: #00b4ff;
      --accent-soft: rgba(0, 180, 255, 0.08);
      --accent-strong: #0284c7;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #ef4444;
      --radius-lg: 18px;
      --radius-xl: 22px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.7);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    a { color: inherit; text-decoration: none; }
    button { font-family: inherit; border: none; cursor: pointer; }

    .app-shell {
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 16px 40px;
      position: relative;
      z-index: 1;
    }

    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.85);
      overflow: hidden;
    }

    .brand-logo-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text h1 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.03em;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .brand-text h1 span.dot { color: var(--accent); }

    .brand-text .subtitle {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .pucv-logo-wrapper {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pucv-logo-wrapper img {
      height: 32px;
      width: auto;
    }

    .pucv-logo-wrapper span {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #cbd5f5;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-name {
      font-size: 12px;
      color: var(--text-soft);
      max-width: 160px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      text-align: right;
    }

    .avatar-chip {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: linear-gradient(135deg, #0f172a, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9);
    }

    .signout-btn {
      margin-left: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .signout-btn:hover {
      background: rgba(15, 23, 42, 1);
      color: #e5e7eb;
    }

    .nav-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      padding: 4px;
    }

    .nav-tab {
      flex: 1;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text-soft);
      text-align: center;
      background: transparent;
    }

    .nav-tab.active {
      background: var(--accent-soft);
      color: #e0f2fe;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }

    .main-card {
      border-radius: var(--radius-xl);
      background: radial-gradient(circle at top left, #111827, #020617 70%);
      border: 1px solid rgba(148, 163, 184, 0.13);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 18px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 10px;
    }

    .section-header h2 {
      font-size: 17px;
      letter-spacing: 0.03em;
    }

    .section-header p {
      font-size: 11px;
      color: var(--text-soft);
      max-width: 480px;
    }

    .section-controls {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 11px;
    }

    .section-controls label {
      color: var(--text-soft);
      margin-right: 2px;
    }

    select,
    input[type="number"],
    input[type="text"],
    input[type="email"],
    textarea {
      font-size: 11px;
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      width: auto;
    }

    textarea {
      border-radius: 14px;
      width: 100%;
      min-height: 70px;
      resize: vertical;
      padding: 7px 9px;
    }

    .explorar-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1fr);
      gap: 14px;
    }

    #gym-map {
      width: 100%;
      height: 310px;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
      z-index: 1;
    }

    .gym-cards {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 310px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .gym-card {
      border-radius: var(--radius-lg);
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 10px 10px 9px;
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.2fr);
      column-gap: 10px;
      row-gap: 6px;
      font-size: 11px;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .gym-card h3 { font-size: 13px; margin-bottom: 3px; }

    .gym-card.selected-compare {
      border-color: rgba(239, 68, 68, 0.9);
      box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.6);
      background: rgba(24, 24, 27, 0.98);
    }

    .gym-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(15, 23, 42, 1);
      border: 1px solid rgba(148, 163, 184, 0.45);
      color: #e5e7eb;
    }

    .gym-meta {
      color: var(--text-soft);
      margin-top: 4px;
      line-height: 1.4;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
    }

    .badge-busy {
      background: rgba(248, 113, 113, 0.12);
      color: #fecaca;
    }

    .badge-free {
      background: rgba(34, 197, 94, 0.12);
      color: #bbf7d0;
    }

    .badge-medium {
      background: rgba(234, 179, 8, 0.12);
      color: #fef3c7;
    }

    .gym-actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 5px;
    }

    .btn-ghost,
    .btn-primary {
      padding: 5px 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.94);
      color: var(--text-soft);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #0b1120;
      font-weight: 600;
      border: none;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 1);
      color: #e5e7eb;
    }

    .btn-primary:hover { filter: brightness(1.05); }

    .gym-price {
      text-align: right;
      font-size: 11px;
      color: #e2e8f0;
    }

    .gym-price strong { font-size: 13px; }

    /* Modal gen√©rico */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.82);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal {
      width: min(640px, 92vw);
      background: #020617;
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 24px 70px rgba(15, 23, 42, 0.9);
      padding: 14px 16px 14px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 12px;
    }

    .modal-header h3 { font-size: 14px; }
    .modal-header small { font-size: 11px; color: var(--text-soft); }

    .modal-gym-head {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
    }

    .gym-logo {
      width: 20px;
      height: 20px;
      object-fit: contain;
      border-radius: 999px;
      background: #020617;
    }

    .modal-close {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover { background: rgba(15, 23, 42, 1); }

    .compare-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 11px;
    }

    .compare-table th,
    .compare-table td {
      padding: 5px 6px;
      border-bottom: 1px solid rgba(31, 41, 55, 1);
    }

    .compare-table th {
      text-align: left;
      color: var(--text-soft);
      font-weight: 500;
    }

    .compare-table td:nth-child(2),
    .compare-table td:nth-child(3) {
      text-align: center;
    }

    .modal-footer {
      margin-top: 10px;
      text-align: right;
    }

    .modal-footer button {
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-soft);
    }

    .modal-footer button:hover {
      background: rgba(15, 23, 42, 1);
      color: #e5e7eb;
    }

    /* Login */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #020617, #020617 40%, #000000 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }

    .login-card {
      width: min(420px, 92vw);
      background: rgba(15, 23, 42, 0.96);
      border-radius: 24px;
      padding: 24px 22px 20px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 26px 80px rgba(15, 23, 42, 0.95);
    }

    .login-title {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 10px;
    }

    .login-title h2 { font-size: 22px; }
    .login-title span { font-size: 11px; color: var(--text-soft); }

    /* logo m√°s grande solo en login */
    .login-card .brand-logo {
      width: 72px;
      height: 72px;
    }

    .login-body p {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    .login-alert {
      font-size: 11px;
      color: #fecaca;
      background: rgba(248, 113, 113, 0.08);
      border: 1px solid rgba(248, 113, 113, 0.5);
      border-radius: 12px;
      padding: 6px 8px;
      margin-bottom: 10px;
    }

    .google-btn {
      width: 100%;
      margin-top: 6px;
      padding: 10px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f97316, #22c55e);
      color: #0b1120;
      font-weight: 600;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
    }

    .google-btn img { width: 16px; height: 16px; }

    .login-small {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-soft);
      text-align: center;
    }

    .login-error {
      margin-top: 6px;
      font-size: 11px;
      color: #fecaca;
      min-height: 14px;
    }

    /* Perfil estilo formulario */
    .perfil-form-card {
      margin-top: 4px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .perfil-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px 12px;
      font-size: 12px;
    }

    .perfil-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .perfil-field label {
      font-size: 11px;
      color: var(--text-soft);
    }

    .perfil-field input,
    .perfil-field select {
      width: 100%;
    }

    .perfil-field.wide {
      grid-column: 1 / -1;
    }

    .perfil-field textarea {
      border-radius: 12px;
      min-height: 52px;
    }

    .perfil-note {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 10px;
    }

    .perfil-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    .perfil-actions .btn-primary {
      padding: 6px 14px;
      font-size: 12px;
    }

    .perfil-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 10px;
      color: var(--text-soft);
    }

    /* chips lesiones */
    .lesiones-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .lesiones-chips label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
    }

    .lesiones-chips input[type="checkbox"] {
      accent-color: #38bdf8;
    }

    /* Mis rutinas */
    .routines-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
    }

    .routines-header-text h2 {
      font-size: 17px;
      letter-spacing: 0.03em;
    }

    .routines-header-text p {
      font-size: 11px;
      color: var(--text-soft);
      max-width: 520px;
      margin-top: 3px;
    }

    .routines-block-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .routines-block-sub {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .routines-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
    }

    .routine-card,
    .user-routine-card {
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 10px 12px 10px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .routine-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .routine-level {
      display: inline-flex;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(59, 130, 246, 0.18);
      color: #bfdbfe;
      border: 1px solid rgba(59, 130, 246, 0.6);
    }

    .routine-meta {
      font-size: 11px;
      color: #cbd5f5;
    }

    .routine-desc {
      font-size: 11px;
      color: var(--text-soft);
    }

    .routine-ex-list {
      font-size: 11px;
      color: #e5e7eb;
      margin-left: 14px;
    }

    .user-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 10%, #93c5fd, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: #e5f0ff;
    }

    .user-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .user-name-card {
      font-size: 12px;
      font-weight: 600;
    }

    .user-degree {
      font-size: 11px;
      color: var(--text-soft);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 4px;
      font-size: 10px;
    }

    .badge-chip {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-soft);
    }

    .badge-level-basic,
    .badge-level-intermediate {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .badge-level-basic {
      background: rgba(234, 179, 8, 0.12);
      color: #fef3c7;
    }

    .badge-level-intermediate {
      background: rgba(59, 130, 246, 0.18);
      color: #bfdbfe;
    }

    .user-routine-title {
      font-size: 13px;
      font-weight: 600;
      margin-top: 5px;
    }

    .user-routine-desc {
      font-size: 11px;
      color: var(--text-soft);
    }

    .routine-footer {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }

    .routine-footer .btn-primary,
    .routine-footer .btn-ghost {
      padding-inline: 10px;
      padding-block: 4px;
      font-size: 11px;
    }

    .routines-note {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 6px;
    }

    [hidden] { display: none !important; }

    @media (max-width: 880px) {
      .explorar-layout { grid-template-columns: minmax(0, 1fr); }
      #gym-map { height: 260px; }
      .perfil-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .routines-header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-overlay" class="login-overlay" hidden>
    <div class="login-card">
      <div class="login-title">
        <div class="brand-logo">
          <img src="matchgym_logo_transparent.png" alt="MatchGym" class="brand-logo-img" />
        </div>
        <div>
          <h2>MatchGym ¬∑ PUCV</h2>
          <span>Acceso exclusivo con correo institucional</span>
        </div>
      </div>
      <div class="login-body">
        <p>
          Para usar la herramienta, inicia sesi√≥n con tu cuenta
          <strong>@mail.pucv.cl</strong>. Solo se permite acceso a estudiantes y
          docentes de la PUCV.
        </p>
        <div class="login-alert">
          Solo se aceptan correos que terminen en <strong>@mail.pucv.cl</strong>.
          Si intentas con otra cuenta, el sistema rechazar√° el acceso.
        </div>
        <button id="google-login-btn" class="google-btn">
          <img
            src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
            alt="Google"
          />
          Ingresar con Google PUCV
        </button>
        <div id="login-error" class="login-error"></div>
        <p class="login-small">
          Proyecto interno para comparar gimnasios y planes cercanos a las sedes de la
          PUCV. Tus datos solo se usan para mostrar tu nombre y correo.
        </p>
      </div>
    </div>
  </div>

  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo">
          <img src="matchgym_logo_transparent.png" alt="MatchGym" class="brand-logo-img" />
        </div>
        <div class="brand-text">
          <h1>
            MatchGym
            <span class="dot">¬∑</span>
            <span>PUCV</span>
          </h1>
          <div class="subtitle">
            Herramienta para elegir gimnasios y rutinas cerca de las sedes PUCV
          </div>
          <div class="pucv-logo-wrapper">
            <img src="pucv-logo.png" alt="PUCV" />
            <span>Pontificia Universidad Cat√≥lica de Valpara√≠so</span>
          </div>
        </div>
      </div>

      <div class="user-info">
        <div class="user-name" id="user-name-label">Sesi√≥n no iniciada</div>
        <div class="avatar-chip" id="user-avatar">--</div>
        <button id="sign-out-btn" class="signout-btn" hidden>Salir</button>
      </div>
    </header>

    <nav class="nav-tabs">
      <button class="nav-tab active" data-section="explorar">
        Explorar gimnasios
      </button>
      <button class="nav-tab" data-section="rutinas">
        Mis rutinas
      </button>
      <button class="nav-tab" data-section="perfil">
        Mi perfil
      </button>
    </nav>

    <!-- EXPLORAR GIMNASIOS -->
    <section id="section-explorar" class="main-card">
      <div class="section-header">
        <div>
          <h2>Explorar gimnasios</h2>
          <p>
            SEDE de origen:
            <strong id="sede-label">Edificio Isabel Brown Caces PUCV ¬∑ Av. Brasil 2241</strong>
          </p>
        </div>
        <div class="section-controls">
          <div>
            <label for="sede-select">Sede</label>
            <select id="sede-select">
              <option value="ibc">IBC ¬∑ Av. Brasil 2241</option>
              <option value="casa-central">Casa Central</option>
              <option value="curauma">Campus Curauma</option>
            </select>
          </div>
          <div>
            <label for="afluencia-filter">Afluencia</label>
            <select id="afluencia-filter">
              <option value="todos">Todos</option>
              <option value="baja">Baja</option>
              <option value="media">Media</option>
              <option value="alta">Alta</option>
            </select>
          </div>
          <div>
            <label for="max-distance">M√°x. distancia (km)</label>
            <input id="max-distance" type="number" min="0.5" max="5" step="0.5" value="3" />
          </div>
        </div>
      </div>

      <div class="explorar-layout">
        <div id="gym-map"></div>
        <div class="gym-cards" id="gym-cards"></div>
      </div>
    </section>

    <!-- MIS RUTINAS -->
    <section id="section-rutinas" class="main-card" hidden>
      <div class="routines-header">
        <div class="routines-header-text">
          <h2>Mis rutinas</h2>
          <p>
            Respecto a los <strong>antecedentes que registraste en tu perfil</strong>
            (peso, nivel, lesiones y d√≠as disponibles), MatchGym te sugiere rutinas
            pensadas para estudiantes PUCV con un contexto parecido al tuyo.
            Puedes <strong>adoptar rutinas de otros estudiantes</strong> para no
            partir desde cero.
          </p>
        </div>
      </div>

      <!-- Guardadas -->
      <div style="margin-top:4px;">
        <div class="routines-block-title">Mis rutinas guardadas</div>
        <div class="routines-block-sub">
          Rutinas que est√°s usando actualmente. Al adoptar una rutina nueva de un
          mismo grupo muscular, se reemplaza la anterior (no se acumulan por acumular).
        </div>
        <div id="saved-routines" class="routines-grid"></div>
      </div>

      <!-- Recomendadas -->
      <div style="margin-top:16px;">
        <div class="routines-block-title">Rutinas recomendadas (otros estudiantes)</div>
        <div class="routines-block-sub">
          Se filtran seg√∫n las <strong>lesiones/condiciones</strong> que marcaste en
          tu perfil. Si marcas rodilla o lumbar, se ocultan las rutinas que podr√≠an
          molestarte.
        </div>
        <div id="recommended-routines" class="routines-grid"></div>

        <p class="routines-note">
          M√°s adelante, estas recomendaciones se generar√°n autom√°ticamente usando tu
          historial de progreso y las rutinas que mejor han funcionado a otros usuarios.
        </p>
      </div>
    </section>

    <!-- MI PERFIL -->
    <section id="section-perfil" class="main-card" hidden>
      <div class="section-header">
        <div>
          <h2>Mi perfil</h2>
          <p>
            Tu perfil se vincula a tu correo institucional PUCV y se usa para
            personalizar recomendaciones de gimnasios y rutinas (nivel, objetivos,
            lesiones y tiempo disponible).
          </p>
        </div>
        <div class="perfil-badge">
          ‚ÄúDebido a tus antecedentes, las mejores rutinas son‚Ä¶‚Äù
        </div>
      </div>

      <div class="perfil-form-card">
        <div class="perfil-grid">
          <div class="perfil-field wide">
            <label for="perfil-email">Correo institucional PUCV</label>
            <input id="perfil-email" type="email" readonly placeholder="@mail.pucv.cl" />
          </div>

          <div class="perfil-field">
            <label for="perfil-peso">Peso (kg)</label>
            <input id="perfil-peso" type="number" min="30" max="250" />
          </div>

          <div class="perfil-field">
            <label for="perfil-estatura">Estatura (cm)</label>
            <input id="perfil-estatura" type="number" min="130" max="220" />
          </div>

          <div class="perfil-field">
            <label for="perfil-edad">Edad</label>
            <input id="perfil-edad" type="number" min="15" max="80" />
          </div>

          <div class="perfil-field">
            <label for="perfil-nivel">Nivel / experiencia</label>
            <select id="perfil-nivel">
              <option value="principiante">Principiante (0‚Äì1 a√±o)</option>
              <option value="intermedio">Intermedio (2‚Äì4 a√±os)</option>
              <option value="avanzado">Avanzado (4+ a√±os)</option>
            </select>
          </div>

          <div class="perfil-field">
            <label for="perfil-anios">A√±os de entrenamiento</label>
            <input id="perfil-anios" type="number" min="0" max="20" />
          </div>

          <div class="perfil-field">
            <label for="perfil-disponibilidad">Disponibilidad semanal (d√≠as)</label>
            <input id="perfil-disponibilidad" type="number" min="1" max="7" />
          </div>

          <div class="perfil-field">
            <label>Condiciones / lesiones relevantes</label>
            <div id="perfil-lesiones-group" class="lesiones-chips">
              <label><input type="checkbox" value="rodilla" /> Lesi√≥n de rodilla</label>
              <label><input type="checkbox" value="lumbar" /> Lesi√≥n lumbar</label>
              <label><input type="checkbox" value="hombro" /> Lesi√≥n de hombro</label>
            </div>
          </div>

          <div class="perfil-field wide">
            <label for="perfil-preferencias">Preferencias de gimnasio</label>
            <input id="perfil-preferencias" type="text"
                   placeholder="Ej: Cerca de la sede, precio, poca afluencia" />
          </div>

          <div class="perfil-field wide">
            <label for="perfil-objetivos">Objetivos</label>
            <textarea id="perfil-objetivos"
              placeholder="Ej: Ganar fuerza, hipertrofia."></textarea>
          </div>
        </div>

        <p class="perfil-note">
          Podr√°s controlar qui√©n ve tus rutinas y datos en la plataforma cuando
          incorporemos el m√≥dulo social completo.
        </p>

        <div class="perfil-actions">
          <button id="save-profile-btn" class="btn-primary">Guardar perfil</button>
        </div>
      </div>
    </section>
  </div>

  <!-- MODAL COMPARACI√ìN GIMNASIOS -->
  <div id="compare-overlay" class="modal-overlay" hidden>
    <div class="modal">
      <div class="modal-header">
        <div>
          <h3>Comparaci√≥n de gimnasios</h3>
          <small id="compare-names"></small>
        </div>
        <button id="compare-close" class="modal-close">√ó</button>
      </div>
      <table class="compare-table">
        <thead>
          <tr>
            <th>Aspecto</th>
            <th id="col-a"></th>
            <th id="col-b"></th>
          </tr>
        </thead>
        <tbody id="compare-body"></tbody>
      </table>
      <div class="modal-footer">
        <button id="compare-close-bottom">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DETALLE RUTINA -->
  <div id="routine-overlay" class="modal-overlay" hidden>
    <div class="modal">
      <div class="modal-header">
        <div>
          <h3 id="routine-modal-title"></h3>
          <small id="routine-modal-subtitle"></small>
        </div>
        <button id="routine-close" class="modal-close">√ó</button>
      </div>
      <div id="routine-modal-body"
           style="font-size:12px;color:var(--text-soft);max-height:260px;overflow-y:auto;"></div>
      <div class="modal-footer">
        <button id="routine-close-bottom">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyCC5XJy3oqmDoTKgDMefB1zjp7XAFgTxWo",
      authDomain: "matchgym-e7df0.firebaseapp.com",
      projectId: "matchgym-e7df0",
      storageBucket: "matchgym-e7df0.firebasestorage.app",
      messagingSenderId: "766710296254",
      appId: "1:766710296254:web:a01ca1d2ee5d362b45b8ef",
      measurementId: "G-D4VWL0H0K9",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    // SEDES Y GIMNASIOS
    const sedes = {
      ibc: {
        nombre: "Edificio Isabel Brown Caces PUCV ¬∑ Av. Brasil 2241",
        center: [-33.0435, -71.6214],
        gyms: [
          {
            id: "smartfit-puerto",
            nombre: "SmartFit Estaci√≥n Puerto",
            cadena: "SmartFit",
            logo: "smartfit-logo.png",
            coords: [-33.0389, -71.6273],
            distanciaKm: 0.7,
            afluencia: "media",
            precio: 25990,
            matricula: 19990,
            horarioPeak: "18‚Äì21 h",
            comentarios:
              "Ubicado en Paseo del Puerto, ideal si bajas en Metro Estaci√≥n Puerto.",
          },
          {
            id: "sportlife-brasil",
            nombre: "Sportlife Valpara√≠so",
            cadena: "Sportlife",
            logo: "sportlife-logo.png",
            coords: [-33.0442, -71.6226],
            distanciaKm: 0.6,
            afluencia: "alta",
            precio: 32990,
            matricula: 24990,
            horarioPeak: "17‚Äì20 h",
            comentarios:
              "Local amplio en Av. Brasil, a pocas cuadras del IBC y Parque Italia.",
          },
          {
            id: "smartfit-victoria",
            nombre: "SmartFit Plaza Victoria",
            cadena: "SmartFit",
            logo: "smartfit-logo.png",
            coords: [-33.0448, -71.6196],
            distanciaKm: 0.8,
            afluencia: "alta",
            precio: 25990,
            matricula: 19990,
            horarioPeak: "17‚Äì22 h",
            comentarios:
              "Muy concurrido, pero con buena rotaci√≥n de m√°quinas cerca de Plaza Victoria.",
          },
          {
            id: "seven",
            nombre: "Gimnasio Seven",
            cadena: "Seven",
            logo: "seven-logo.png",
            coords: [-33.0452, -71.6174],
            distanciaKm: 1.0,
            afluencia: "media",
            precio: 24990,
            matricula: 15000,
            horarioPeak: "19‚Äì21 h",
            comentarios:
              "Referencia m√°s local en Pedro Montt, cerca del L√≠der. Ambiente m√°s familiar.",
          },
          {
            id: "pacific-ross",
            nombre: "Pacific Gym Mall Paseo Ross",
            cadena: "Pacific",
            logo: "pacific-logo.png",
            coords: [-33.0437, -71.6203],
            distanciaKm: 1.3,
            afluencia: "baja",
            precio: 23990,
            matricula: 0,
            horarioPeak: "18‚Äì20 h",
            comentarios:
              "Dentro del Mall Paseo Ross; suele tener menor afluencia en la ma√±ana.",
          },
        ],
      },
      "casa-central": {
        nombre: "Casa Central PUCV ¬∑ Av. Brasil 2950",
        center: [-33.0437, -71.6245],
        gyms: [
          {
            id: "gym-casa-central",
            nombre: "Gimnasio Casa Central PUCV",
            cadena: "PUCV",
            logo: "pucv-logo.png",
            coords: [-33.0439, -71.6248],
            distanciaKm: 0.0,
            afluencia: "media",
            precio: 0,
            matricula: 0,
            horarioPeak: "13‚Äì16 h",
            comentarios:
              "Gimnasio institucional para estudiantes PUCV (ejemplo ficticio).",
          },
        ],
      },
      curauma: {
        nombre: "Campus Curauma PUCV",
        center: [-33.0704, -71.4306],
        gyms: [
          {
            id: "curauma-fit",
            nombre: "Curauma Fitness",
            cadena: "Local",
            logo: "curauma-logo.png",
            coords: [-33.0704, -71.4306],
            distanciaKm: 0.4,
            afluencia: "media",
            precio: 19990,
            matricula: 15000,
            horarioPeak: "18‚Äì21 h",
            comentarios: "Ejemplo de gimnasio cercano al Campus Curauma.",
          },
        ],
      },
    };

    // LOGIN UI
    const loginOverlay = document.getElementById("login-overlay");
    const loginBtn = document.getElementById("google-login-btn");
    const loginError = document.getElementById("login-error");
    const userNameLabel = document.getElementById("user-name-label");
    const userAvatar = document.getElementById("user-avatar");
    const signOutBtn = document.getElementById("sign-out-btn");

    loginBtn.addEventListener("click", async () => {
      loginError.textContent = "";
      try {
        const result = await auth.signInWithPopup(provider);
        const email = result.user.email || "";
        if (!email.endsWith("@mail.pucv.cl")) {
          await auth.signOut();
          loginError.textContent =
            "Solo se permite el acceso con correos @mail.pucv.cl. Intenta nuevamente con tu cuenta institucional.";
        }
      } catch (err) {
        console.error(err);
        loginError.textContent = "No se pudo iniciar sesi√≥n. Intenta nuevamente.";
      }
    });

    signOutBtn.addEventListener("click", () => auth.signOut());

    // NAV TABS
    const navTabs = document.querySelectorAll(".nav-tab");
    const sections = {
      explorar: document.getElementById("section-explorar"),
      rutinas: document.getElementById("section-rutinas"),
      perfil: document.getElementById("section-perfil"),
    };

    navTabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        navTabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        const key = tab.dataset.section;
        Object.entries(sections).forEach(([k, el]) => (el.hidden = k !== key));
      });
    });

    // MAPA
    const initialSedeKey = "ibc";
    let currentSedeKey = initialSedeKey;

    const map = L.map("gym-map", {
      zoomControl: true,
      attributionControl: false,
    }).setView(sedes[initialSedeKey].center, 15.5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);
    let sedeMarker = null;
    let gymMarkers = {}; // id -> marker

    const defaultGymStyle = {
      radius: 7,
      color: "#0ea5e9",
      fillColor: "#38bdf8",
      fillOpacity: 0.95,
      weight: 2,
    };

    const selectedGymStyle = {
      radius: 8,
      color: "#ef4444",
      fillColor: "#f97373",
      fillOpacity: 0.95,
      weight: 2,
    };

    const sedeIcon = L.icon({
      iconUrl: "pucv-escudo.png",
      iconSize: [40, 40],
      iconAnchor: [20, 20],
      popupAnchor: [0, -22],
    });

    // CONTROLES EXPLORAR
    const sedeSelect = document.getElementById("sede-select");
    const sedeLabel = document.getElementById("sede-label");
    const afluenciaFilter = document.getElementById("afluencia-filter");
    the
    const maxDistanceInput = document.getElementById("max-distance");
    const gymCardsEl = document.getElementById("gym-cards");

    function afluenciaLabel(af) {
      if (af === "baja") return "Baja afluencia";
      if (af === "media") return "Afluencia media";
      if (af === "alta") return "Muy concurrido";
      return af;
    }

    function afluenciaClass(af) {
      if (af === "baja") return "badge-free";
      if (af === "media") return "badge-medium";
      if (af === "alta") return "badge-busy";
      return "";
    }

    function formatoPrecio(v) {
      if (!v || v === 0) return "Incluido (ejemplo)";
      return "$" + v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function renderGyms() {
      const sede = sedes[currentSedeKey];
      sedeLabel.textContent = sede.nombre;

      const maxDist = parseFloat(maxDistanceInput.value || "3");
      const filter = afluenciaFilter.value;

      markersLayer.clearLayers();
      gymMarkers = {};

      if (sedeMarker) map.removeLayer(sedeMarker);
      sedeMarker = L.marker(sede.center, { icon: sedeIcon })
        .addTo(map)
        .bindPopup("Sede PUCV (origen)");

      const gymsFiltrados = sede.gyms.filter((g) => {
        if (g.distanciaKm > maxDist) return false;
        if (filter !== "todos" && g.afluencia !== filter) return false;
        return true;
      });

      const tempMarkers = [];

      gymsFiltrados.forEach((gym) => {
        const marker = L.circleMarker(gym.coords, defaultGymStyle)
          .addTo(markersLayer)
          .bindPopup(
            `<strong>${gym.nombre}</strong><br>${gym.distanciaKm.toFixed(
              1
            )} km desde la sede`
          );
        gymMarkers[gym.id] = marker;
        tempMarkers.push(marker);
      });

      if (gymsFiltrados.length > 0) {
        const group = L.featureGroup([sedeMarker, ...tempMarkers]);
        map.fitBounds(group.getBounds().pad(0.2));
      } else {
        map.setView(sede.center, 15.5);
      }

      renderGymCards(gymsFiltrados);
      resetSelection();
    }

    function renderGymCards(gyms) {
      gymCardsEl.innerHTML = "";
      if (gyms.length === 0) {
        gymCardsEl.innerHTML =
          '<p style="font-size:12px;color:var(--text-soft);">No hay gimnasios que cumplan con los filtros actuales.</p>';
        return;
      }

      gyms.forEach((gym) => {
        const card = document.createElement("article");
        card.className = "gym-card";
        card.dataset.id = gym.id;

        card.innerHTML = `
          <div>
            <h3>${gym.nombre}</h3>
            <div class="gym-chip">
              <span>${gym.cadena}</span>
              <span style="opacity:.7">¬∑ ${gym.distanciaKm.toFixed(
                1
              )} km desde la sede</span>
            </div>
            <div class="gym-meta">
              <div class="badge-pill ${afluenciaClass(gym.afluencia)}">
                ${afluenciaLabel(gym.afluencia)}
              </div>
              <div>Horario con m√°s afluencia: ${gym.horarioPeak}</div>
              <div style="margin-top:2px;">${gym.comentarios}</div>
            </div>
          </div>
          <div>
            <div class="gym-price">
              <div style="font-size:11px;color:var(--text-soft);">Plan mensual desde</div>
              <strong>${formatoPrecio(gym.precio)}</strong>
              <div style="font-size:11px;color:var(--text-soft);">
                Matr√≠cula: ${formatoPrecio(gym.matricula)}
              </div>
            </div>
            <div class="gym-actions" style="margin-top:8px;">
              <button class="btn-ghost" data-action="ver-detalle">Ver detalles</button>
              <button class="btn-primary" data-action="comparar">Comparar</button>
            </div>
          </div>
        `;
        gymCardsEl.appendChild(card);
      });
    }

    // SELECCI√ìN PARA COMPARAR GIMNASIOS
    let firstSelectedGym = null;
    let secondSelectedGym = null;

    function highlightCardAndMarker(gymId, isSelected) {
      const card = gymCardsEl.querySelector(`.gym-card[data-id="${gymId}"]`);
      if (card) {
        card.classList.toggle("selected-compare", isSelected);
      }
      const marker = gymMarkers[gymId];
      if (marker) {
        marker.setStyle(isSelected ? selectedGymStyle : defaultGymStyle);
      }
    }

    function resetSelection() {
      firstSelectedGym = null;
      secondSelectedGym = null;
      gymCardsEl
        .querySelectorAll('button[data-action="comparar"]')
        .forEach((b) => {
          b.textContent = "Comparar";
          b.disabled = false;
          b.style.opacity = "1";
        });
      gymCardsEl
        .querySelectorAll(".gym-card.selected-compare")
        .forEach((c) => c.classList.remove("selected-compare"));
      Object.values(gymMarkers).forEach((m) => m.setStyle(defaultGymStyle));
    }

    gymCardsEl.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const card = btn.closest(".gym-card");
      const gymId = card?.dataset.id;
      if (!gymId) return;

      const sede = sedes[currentSedeKey];
      const gym = sede.gyms.find((g) => g.id === gymId);
      if (!gym) return;

      const action = btn.dataset.action;

      if (action === "ver-detalle") {
        alert(
          `${gym.nombre}\n\nCadena: ${gym.cadena}\nDistancia: ${gym.distanciaKm.toFixed(
            1
          )} km\nAfluencia: ${afluenciaLabel(
            gym.afluencia
          )}\n\nComentario:\n${gym.comentarios}`
        );
        return;
      }

      if (action === "comparar") {
        if (!firstSelectedGym) {
          firstSelectedGym = gym;
          btn.textContent = "Seleccionado ‚úì";
          btn.disabled = true;
          btn.style.opacity = "0.7";
          highlightCardAndMarker(gym.id, true);
          return;
        }
        if (firstSelectedGym && firstSelectedGym.id === gym.id) {
          resetSelection();
          return;
        }
        secondSelectedGym = gym;
        highlightCardAndMarker(gym.id, true);
        openCompare(firstSelectedGym, secondSelectedGym);
      }
    });

    // MODAL COMPARACI√ìN
    const compareOverlay = document.getElementById("compare-overlay");
    const compareClose = document.getElementById("compare-close");
    const compareCloseBottom = document.getElementById("compare-close-bottom");
    const compareNamesEl = document.getElementById("compare-names");
    const compareBodyEl = document.getElementById("compare-body");
    const colAEl = document.getElementById("col-a");
    const colBEl = document.getElementById("col-b");

    function getLogoUrl(g) {
      return g.logo || "pucv-logo.png";
    }

    function openCompare(gymA, gymB) {
      compareNamesEl.textContent = `${gymA.nombre} vs. ${gymB.nombre}`;

      colAEl.innerHTML = `
        <div class="modal-gym-head">
          <img src="${getLogoUrl(gymA)}" class="gym-logo" alt="${gymA.cadena}" />
          <span>${gymA.nombre}</span>
        </div>
      `;
      colBEl.innerHTML = `
        <div class="modal-gym-head">
          <img src="${getLogoUrl(gymB)}" class="gym-logo" alt="${gymB.cadena}" />
          <span>${gymB.nombre}</span>
        </div>
      `;

      const rows = [
        ["Cadena", gymA.cadena, gymB.cadena],
        [
          "Distancia desde sede",
          gymA.distanciaKm.toFixed(1) + " km",
          gymB.distanciaKm.toFixed(1) + " km",
        ],
        ["Afluencia", afluenciaLabel(gymA.afluencia), afluenciaLabel(gymB.afluencia)],
        ["Plan mensual", formatoPrecio(gymA.precio), formatoPrecio(gymB.precio)],
        ["Matr√≠cula", formatoPrecio(gymA.matricula), formatoPrecio(gymB.matricula)],
        ["Horario peak", gymA.horarioPeak, gymB.horarioPeak],
        ["Comentario", gymA.comentarios, gymB.comentarios],
      ];

      compareBodyEl.innerHTML = rows
        .map(
          ([aspecto, a, b]) =>
            `<tr><td>${aspecto}</td><td>${a}</td><td>${b}</td></tr>`
        )
        .join("");

      compareOverlay.hidden = false;
    }

    function closeCompare() {
      compareOverlay.hidden = true;
      resetSelection();
    }

    compareClose.addEventListener("click", closeCompare);
    compareCloseBottom.addEventListener("click", closeCompare);
    compareOverlay.addEventListener("click", (e) => {
      if (e.target === compareOverlay) closeCompare();
    });

    // PERFIL + RUTINAS (localStorage)
    const perfilEmail = document.getElementById("perfil-email");
    const perfilPeso = document.getElementById("perfil-peso");
    const perfilEstatura = document.getElementById("perfil-estatura");
    const perfilEdad = document.getElementById("perfil-edad");
    const perfilNivel = document.getElementById("perfil-nivel");
    const perfilAnios = document.getElementById("perfil-anios");
    const perfilDisp = document.getElementById("perfil-disponibilidad");
    const perfilPreferencias = document.getElementById("perfil-preferencias");
    const perfilObjetivos = document.getElementById("perfil-objetivos");
    const saveProfileBtn = document.getElementById("save-profile-btn");

    const lesionesGroup = document.getElementById("perfil-lesiones-group");
    const lesionesCheckboxes = lesionesGroup.querySelectorAll('input[type="checkbox"]');

    const savedRoutinesEl = document.getElementById("saved-routines");
    const recommendedRoutinesEl = document.getElementById("recommended-routines");

    let currentUserKey = "anon";

    function profileKey() {
      return "matchgym_profile_" + currentUserKey;
    }
    function routinesKey() {
      return "matchgym_routines_" + currentUserKey;
    }

    function getSelectedLesionesFromUI() {
      return Array.from(lesionesCheckboxes)
        .filter((cb) => cb.checked)
        .map((cb) => cb.value);
    }

    function setSelectedLesionesFromProfile(arr) {
      const set = new Set(arr || []);
      lesionesCheckboxes.forEach((cb) => {
        cb.checked = set.has(cb.value);
      });
    }

    function loadProfile() {
      const raw = localStorage.getItem(profileKey());
      if (raw) {
        try {
          const p = JSON.parse(raw);
          perfilPeso.value = p.peso ?? "";
          perfilEstatura.value = p.estatura ?? "";
          perfilEdad.value = p.edad ?? "";
          if (p.nivel) perfilNivel.value = p.nivel;
          perfilAnios.value = p.anios ?? "";
          perfilDisp.value = p.disp ?? "";
          perfilPreferencias.value = p.preferencias ?? "";
          perfilObjetivos.value = p.objetivos ?? "";

          if (Array.isArray(p.lesiones)) {
            setSelectedLesionesFromProfile(p.lesiones);
          } else if (typeof p.lesiones === "string" && p.lesiones.length > 0) {
            setSelectedLesionesFromProfile(
              p.lesiones.split(",").map((s) => s.trim())
            );
          }
        } catch (e) {
          console.warn("Perfil corrupto", e);
        }
      } else {
        perfilNivel.value = "principiante";
      }
    }

    function saveProfile() {
      const data = {
        peso: perfilPeso.value,
        estatura: perfilEstatura.value,
        edad: perfilEdad.value,
        nivel: perfilNivel.value,
        anios: perfilAnios.value,
        disp: perfilDisp.value,
        lesiones: getSelectedLesionesFromUI(),
        preferencias: perfilPreferencias.value,
        objetivos: perfilObjetivos.value,
      };
      localStorage.setItem(profileKey(), JSON.stringify(data));
      alert("Perfil guardado üôÇ");
    }

    saveProfileBtn.addEventListener("click", saveProfile);

    lesionesCheckboxes.forEach((cb) =>
      cb.addEventListener("change", () => {
        renderRecommendedRoutines();
      })
    );

    // RUTINAS
    const baseDefaultRoutines = [
      {
        id: "own-pierna",
        title: "Pierna",
        nivel: "Intermedio",
        muscleGroup: "Pierna",
        desc: "Sentadilla (barra), peso muerto (barra) y curl de pierna sentado. Inspirada en enfoque heavy duty (pocas series muy intensas).",
        exercises: [
          "Sentadilla (barra)",
          "Peso muerto (barra)",
          "Curl de pierna sentado",
        ],
        origin: "propia",
      },
      {
        id: "own-espalda",
        title: "Espalda",
        nivel: "Intermedio",
        muscleGroup: "Espalda",
        desc: "Remo inclinado, jal√≥n al pecho y remo a un brazo. Pensada para combinar con tu split actual durante el semestre.",
        exercises: ["Remo inclinado", "Jal√≥n al pecho", "Remo a un brazo"],
        origin: "propia",
      },
    ];

    const recommendedRoutines = [
      {
        id: "juan-pierna-basica",
        owner: "Juan",
        carrera: "Ingenier√≠a Civil PUCV",
        nivel: "Principiante",
        horario: "13:00‚Äì15:00",
        objetivo: "Bajar grasa",
        muscleGroup: "Pierna",
        title: "Pierna b√°sica",
        desc: "Pierna ‚Äî 3 ejercicios. Sentadilla en m√°quina, prensa y curl femoral. Ideal para retomar despu√©s de la universidad.",
        exercises: [
          "Sentadilla en m√°quina",
          "Prensa de piernas",
          "Curl femoral",
        ],
        contraindicaciones: ["rodilla"],
      },
      {
        id: "carla-biceps",
        owner: "Carla",
        carrera: "Pedagog√≠a en F√≠sica PUCV",
        nivel: "Intermedio",
        horario: "19:00‚Äì21:00",
        objetivo: "Fuerza tren superior",
        muscleGroup: "Brazos",
        title: "B√≠ceps ‚Äì 4 ejercicios",
        desc: "Rutina de brazo para 2 d√≠as a la semana. Combina curls pesados y trabajo m√°s controlado, siguiendo la l√≥gica de 2 series efectivas.",
        exercises: [
          "Curl con barra Z",
          "Curl martillo mancuernas",
          "Curl concentrado",
          "Curl en polea",
        ],
        contraindicaciones: [],
      },
      {
        id: "alejandro-espalda",
        owner: "Alejandro",
        carrera: "Ingenier√≠a en Construcci√≥n PUCV",
        nivel: "Principiante",
        horario: "7:00‚Äì9:00",
        objetivo: "Ganar masa",
        muscleGroup: "Espalda",
        title: "Fuerza ‚Äì Espalda 3 ejercicios",
        desc: "Rutina simple de espalda para empezar: jal√≥n al pecho, remo sentado y face pulls. Perfecta para quienes entrenan antes de clases.",
        exercises: [
          "Jal√≥n al pecho",
          "Remo sentado en polea",
          "Face pulls",
        ],
        contraindicaciones: ["hombro", "lumbar"],
      },
    ];

    let savedRoutines = [];

    function loadSavedRoutines() {
      const raw = localStorage.getItem(routinesKey());
      if (raw) {
        try {
          savedRoutines = JSON.parse(raw);
        } catch (e) {
          console.warn("Routines corruptas", e);
          savedRoutines = [...baseDefaultRoutines];
        }
      } else {
        savedRoutines = [...baseDefaultRoutines];
      }
      renderSavedRoutines();
      renderRecommendedRoutines();
    }

    function saveSavedRoutines() {
      localStorage.setItem(routinesKey(), JSON.stringify(savedRoutines));
    }

    function renderSavedRoutines() {
      savedRoutinesEl.innerHTML = "";
      if (!savedRoutines.length) {
        savedRoutinesEl.innerHTML =
          '<p style="font-size:12px;color:var(--text-soft);">A√∫n no tienes rutinas guardadas. Adopta una rutina recomendada y aparecer√° aqu√≠.</p>';
        return;
      }

      savedRoutines.forEach((r) => {
        const card = document.createElement("article");
        card.className = "routine-card";
        card.innerHTML = `
          <div>
            <div class="routine-title">${r.title}</div>
            <span class="routine-level">${r.nivel.toUpperCase()}</span>
          </div>
          <div class="routine-meta">
            Grupo muscular: ${r.muscleGroup} ${
          r.origin === "adoptada" ? `¬∑ Adoptada de ${r.adoptedFrom}` : ""
        }
          </div>
          <p class="routine-desc">${r.desc}</p>
          <ul class="routine-ex-list">
            ${r.exercises.map((ex) => `<li>${ex}</li>`).join("")}
          </ul>
        `;
        savedRoutinesEl.appendChild(card);
      });
    }

    function renderRecommendedRoutines() {
      recommendedRoutinesEl.innerHTML = "";
      const lesionesSel = getSelectedLesionesFromUI();

      const visibles = recommendedRoutines.filter((r) => {
        if (!r.contraindicaciones || r.contraindicaciones.length === 0)
          return true;
        if (lesionesSel.length === 0) return true;
        return !r.contraindicaciones.some((l) => lesionesSel.includes(l));
      });

      if (!visibles.length) {
        recommendedRoutinesEl.innerHTML =
          '<p style="font-size:12px;color:var(--text-soft);">Con las lesiones seleccionadas no hay rutinas sugeridas. Prueba desmarcar alguna lesi√≥n o agrega nuevas rutinas m√°s adelante.</p>';
        return;
      }

      visibles.forEach((r) => {
        const card = document.createElement("article");
        card.className = "user-routine-card";
        card.dataset.id = r.id;
        card.innerHTML = `
          <div class="user-header">
            <div class="avatar">${r.owner[0]}</div>
            <div class="user-meta">
              <span class="user-name-card">${r.owner}</span>
              <span class="user-degree">${r.carrera}</span>
            </div>
          </div>
          <div class="badge-row">
            <span class="${
              r.nivel === "Principiante"
                ? "badge-level-basic"
                : "badge-level-intermediate"
            }">${r.nivel.toUpperCase()}</span>
            <span class="badge-chip">Horario: ${r.horario}</span>
            <span class="badge-chip">Objetivo: ${r.objetivo}</span>
            <span class="badge-chip">Grupo: ${r.muscleGroup}</span>
          </div>
          <div class="user-routine-title">${r.title}</div>
          <p class="user-routine-desc">${r.desc}</p>
          <div class="routine-footer">
            <button class="btn-ghost" data-action="detalle">Ver detalles</button>
            <button class="btn-primary" data-action="adoptar">Adoptar esta rutina</button>
          </div>
        `;
        recommendedRoutinesEl.appendChild(card);
      });
    }

    function adoptRoutine(routineId) {
      const r = recommendedRoutines.find((x) => x.id === routineId);
      if (!r) return;
      const idx = savedRoutines.findIndex(
        (x) => x.muscleGroup === r.muscleGroup
      );
      const newEntry = {
        id: "adopted-" + r.id,
        title: r.title,
        nivel: r.nivel,
        muscleGroup: r.muscleGroup,
        desc: r.desc,
        exercises: r.exercises,
        origin: "adoptada",
        adoptedFrom: r.owner,
      };
      if (idx >= 0) {
        savedRoutines[idx] = newEntry;
      } else {
        savedRoutines.push(newEntry);
      }
      saveSavedRoutines();
      renderSavedRoutines();
      alert(
        `Rutina "${r.title}" adoptada para ${r.muscleGroup}. Si ya ten√≠as una rutina de ese grupo, fue reemplazada.`
      );
    }

    // MODAL RUTINA DETALLE
    const routineOverlay = document.getElementById("routine-overlay");
    const routineTitleEl = document.getElementById("routine-modal-title");
    const routineSubtitleEl = document.getElementById("routine-modal-subtitle");
    const routineBodyEl = document.getElementById("routine-modal-body");
    const routineClose = document.getElementById("routine-close");
    const routineCloseBottom = document.getElementById("routine-close-bottom");

    function openRoutineModal(r) {
      routineTitleEl.textContent = r.title;
      routineSubtitleEl.textContent = `${r.owner} ¬∑ ${r.carrera} ¬∑ ${r.nivel} ¬∑ Grupo: ${r.muscleGroup}`;
      routineBodyEl.innerHTML = `
        <p style="margin-bottom:8px;"><strong>Horario t√≠pico:</strong> ${r.horario}</p>
        <p style="margin-bottom:8px;"><strong>Objetivo principal:</strong> ${r.objetivo}</p>
        <p style="margin-bottom:8px;"><strong>Descripci√≥n:</strong><br>${r.desc}</p>
        <p><strong>Ejercicios:</strong></p>
        <ul style="margin-left:16px;margin-top:4px;">
          ${r.exercises.map((ex) => `<li>${ex}</li>`).join("")}
        </ul>
      `;
      routineOverlay.hidden = false;
    }

    function closeRoutineModal() {
      routineOverlay.hidden = true;
    }

    routineClose.addEventListener("click", closeRoutineModal);
    routineCloseBottom.addEventListener("click", closeRoutineModal);
    routineOverlay.addEventListener("click", (e) => {
      if (e.target === routineOverlay) closeRoutineModal();
    });

    recommendedRoutinesEl.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const card = btn.closest(".user-routine-card");
      if (!card) return;
      const id = card.dataset.id;
      const r = recommendedRoutines.find((x) => x.id === id);
      if (!r) return;

      const action = btn.dataset.action;
      if (action === "detalle") {
        openRoutineModal(r);
      } else if (action === "adoptar") {
        adoptRoutine(id);
      }
    });

    // AUTH STATE
    auth.onAuthStateChanged((user) => {
      if (user && user.email && user.email.endsWith("@mail.pucv.cl")) {
        loginOverlay.hidden = true;
        const displayName = user.displayName || user.email;
        userNameLabel.textContent = displayName;
        userAvatar.textContent = (displayName[0] || "?").toUpperCase();
        signOutBtn.hidden = false;

        currentUserKey = user.uid || user.email;
        perfilEmail.value = user.email;
      } else {
        loginOverlay.hidden = false;
        userNameLabel.textContent = "Sesi√≥n no iniciada";
        userAvatar.textContent = "--";
        signOutBtn.hidden = true;

        currentUserKey = "anon";
        perfilEmail.value = "";
      }
      loadProfile();
      loadSavedRoutines();
    });

    // Filtros mapa
    sedeSelect.addEventListener("change", () => {
      currentSedeKey = sedeSelect.value;
      map.setView(sedes[currentSedeKey].center, 15.5);
      renderGyms();
    });
    afluenciaFilter.addEventListener("change", renderGyms);
    maxDistanceInput.addEventListener("change", renderGyms);

    // Inicial
    renderGyms();
  </script>
</body>
</html>
